enums:
  JobStatus:
    values:
      - PENDING
      - RUNNING
      - COMPLETED
      - FAILED
      - CANCELLED
  AgentStatus:
    values:
      - ONLINE
      - OFFLINE
      - BUSY

models:
  Job:
    role: job-owner
    test:
      actor: user
    fields:
      id:
        type: String
        attributes:
          - '@id'
          - '@default(cuid())'
      type:
        type: String
      userId:
        type: String
        isRequired: false
      actorId:
        type: String
        isRequired: false
      actorType:
        type: String
        isRequired: false
      payload:
        type: Json
        attributes:
          - '@default("{}")'
      result:
        type: Json
        isRequired: false
      error:
        type: Json
        isRequired: false
      status:
        type: JobStatus
        attributes:
          - '@default(PENDING)'
      progress:
        type: Int
        attributes:
          - '@default(0)'
      lockedBy:
        type: String
        isRequired: false
      lockedAt:
        type: DateTime
        isRequired: false
      startedAt:
        type: DateTime
        isRequired: false
      completedAt:
        type: DateTime
        isRequired: false
      createdAt:
        type: DateTime
        attributes:
          - '@default(now())'
      updatedAt:
        type: DateTime
        attributes:
          - '@updatedAt'
      # Retry mechanism fields
      retryCount:
        type: Int
        attributes:
          - '@default(0)'
      maxRetries:
        type: Int
        attributes:
          - '@default(3)'
      nextRetryAt:
        type: DateTime
        isRequired: false
      logs:
        type: JobLog
        isList: true
        attributes:
          - '@relation("JobLogs")'

  JobLog:
    role: job-owner
    test:
      actor: user
    fields:
      id:
        type: String
        attributes:
          - '@id'
          - '@default(cuid())'
      jobId:
        type: String
      level:
        type: String
        attributes:
          - '@default("INFO")'
      message:
        type: String
      timestamp:
        type: DateTime
        attributes:
          - '@default(now())'
      job:
        type: Job
        attributes:
          - '@relation("JobLogs", fields: [jobId], references: [id], onDelete: Cascade)'

  Agent:
    actor:
      strategy: bearer
      prefix: ''
      fields:
        id: id
    test:
      actor: agent
    fields:
      id:
        type: String
        attributes:
          - '@id'
          - '@default(cuid())'
      name:
        type: String
        isRequired: false
      hashedKey:
        type: String
        isRequired: false
      prefix:
        type: String
        isRequired: false
      hostname:
        type: String
      capabilities:
        type: String
        isList: true
      lastHeartbeat:
        type: DateTime
        attributes:
          - '@default(now())'
      status:
        type: AgentStatus
        attributes:
          - '@default(ONLINE)'
      createdAt:
        type: DateTime
        attributes:
          - '@default(now())'

  User:
    db: false
    api: false
    actor:
      name: user
      prefix: ne_pat_
      strategy: bearer
      fields:
        tokenModel: PersonalAccessToken
        ownerField: userId
        keyField: hashedKey
    fields:
      id: String

  PersonalAccessToken:
    db: false
    api: false
    fields:
      hashedKey: String
      userId: String
      prefix: String

  # Dead-letter queue for permanently failed jobs
  DeadLetterJob:
    role: admin
    test:
      actor: user
    fields:
      id:
        type: String
        attributes:
          - '@id'
          - '@default(cuid())'
      originalJobId:
        type: String
      type:
        type: String
      payload:
        type: Json
        attributes:
          - '@default("{}")'
      error:
        type: Json
        attributes:
          - '@default("{}")'
      failedAt:
        type: DateTime
        attributes:
          - '@default(now())'
      retryCount:
        type: Int
      reason:
        type: String
        isRequired: false
      actorId:
        type: String
        isRequired: false
      actorType:
        type: String
        isRequired: false

  # DTOs
  CreateJobDTO:
    db: false
    api: false
    fields:
      type:
        type: String
        isRequired: true
      payload:
        type: Json
        isRequired: true
      actorId:
        type: String
        isRequired: false
      actorType:
        type: String
        isRequired: false
      userId:
        type: String
        isRequired: false

  PollJobsDTO:
    db: false
    api: false
    fields:
      agentId:
        type: String
        isRequired: true
      capabilities:
        type: String
        isList: true

  UpdateProgressDTO:
    db: false
    api: false
    fields:
      id:
        type: String
        isRequired: true
      progress:
        type: Int
        isRequired: true

  JobMetrics:
    db: false
    api: false
    fields:
      total:
        type: Int
      pending:
        type: Int
      running:
        type: Int
      completed:
        type: Int
      failed:
        type: Int
      cancelled:
        type: Int
      avgCompletionTimeMs:
        type: Float
        isRequired: false
      retryRate:
        type: Float
      successRate:
        type: Float

  AgentMetrics:
    db: false
    api: false
    fields:
      total:
        type: Int
      online:
        type: Int
      offline:
        type: Int
      busy:
        type: Int
      jobsProcessedLast24h:
        type: Int

  # Job Action DTOs
  CompleteJobDTO:
    db: false
    api: false
    fields:
      id:
        type: String
        isRequired: true
      result:
        type: Json
        isRequired: false

  FailJobDTO:
    db: false
    api: false
    fields:
      id:
        type: String
        isRequired: true
      error:
        type: Json
        isRequired: false

  CancelJobDTO:
    db: false
    api: false
    fields:
      id:
        type: String
        isRequired: true

  HeartbeatDTO:
    db: false
    api: false
    fields:
      id:
        type: String
        isRequired: true

  RegisterAgentDTO:
    db: false
    api: false
    fields:
      id:
        type: String
        isRequired: false
      hostname:
        type: String
        isRequired: true
      capabilities:
        type: String
        isList: true
