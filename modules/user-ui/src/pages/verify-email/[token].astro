---
import Layout from "@/layouts/Layout.astro";
import { VerifyEmailAuthAction } from "@modules/user-api/src/actions/verify-email-auth";
import { config } from "@/lib/core/config";
import { ModuleI18nIntegration } from "@/lib/integrations/module-i18n-integration";
import { PageGuard } from "@/lib/ui/page-guard";
import {
    Card,
    CardHeader,
    CardTitle,
    CardContent,
    CardDescription,
} from "@/components/ui/card";
import { buttonVariants } from "@/components/ui/button";

const guard = await PageGuard.protect(Astro, "anonymous");
if (guard) return guard;

const lang =
    Astro.cookies.get("i18next")?.value ||
    config.PUBLIC_DEFAULT_LANGUAGE ||
    "en";
const store = await ModuleI18nIntegration.getMergedLocale(lang);
function t(key: string) {
    return key.split(".").reduce((o: any, i) => o?.[i], store) || key;
}

const { token } = Astro.params;

let success = false;
let error = "";

if (!token) {
    return Astro.redirect("/login?error=InvalidToken");
}

const result = await VerifyEmailAuthAction.run({ token });
if (result.success) {
    success = true;
} else {
    error = result.error ? t(result.error) : "Failed";
}
---

<Layout title={t("user.pages.verify_email.title_token")}>
    {
        success ? (
            <Card className="auth-card">
                <CardHeader>
                    <CardTitle
                        className="auth-card-title text-success"
                        data-testid="verify-email-success-heading"
                    >
                        {t("user.pages.verify_email.success_heading")}
                    </CardTitle>
                    <CardDescription
                        className="auth-card-description"
                        data-testid="verify-email-success-message"
                    >
                        {t("user.pages.verify_email.success_message")}
                    </CardDescription>
                </CardHeader>
                <CardContent className="auth-form-container">
                    <a
                        href="/login"
                        class={buttonVariants({
                            variant: "default",
                            className: "auth-submit-button w-full",
                        })}
                    >
                        {t("user.pages.verify_email.go_to_login")}
                    </a>
                </CardContent>
            </Card>
        ) : (
            <Card className="auth-card">
                <CardHeader>
                    <CardTitle
                        className="auth-card-title text-destructive"
                        data-testid="verify-email-error-heading"
                    >
                        {t("user.pages.verify_email.failed_heading")}
                    </CardTitle>
                    <CardDescription
                        className="auth-card-description"
                        data-testid="verify-email-error-message"
                    >
                        {error ||
                            t("user.pages.verify_email.failed_message_default")}
                    </CardDescription>
                </CardHeader>
                <CardContent className="auth-form-container">
                    <a
                        href="/login"
                        class={buttonVariants({
                            variant: "default",
                            className: "auth-submit-button w-full",
                        })}
                    >
                        {t("user.pages.verify_email.back_to_login")}
                    </a>
                </CardContent>
            </Card>
        )
    }
</Layout>
